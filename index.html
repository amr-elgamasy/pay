<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فلوسنا - المحفظة الجماعية</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Arabic) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- AOS Animation Library -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <!-- Chart.js for Charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Arabic Font Support for jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <link rel="stylesheet" href="styel.css">

</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 10000; justify-content: center; align-items: center;">
        <div style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 3rem; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            <p style="margin-top: 15px; font-size: 16px; color: white; font-weight: 600;">جاري المعالجة...</p>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-wallet"></i>
                <span style="font-weight: 700; font-size: 1.3rem;">فلوسنا</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-page="home">
                        <i class="fas fa-home"></i>
                        <span>الرئيسية</span>
                    </a></li>
                    <li><a href="#" class="nav-link" data-page="deposits">
                        <i class="fas fa-list"></i>
                        <span>السجل</span>
                    </a></li>
                    <li><a href="#" class="nav-link" data-page="admin">
                        <i class="fas fa-cog"></i>
                        <span>لوحة التحكم</span>
                    </a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <section id="home" class="page active">
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);" data-aos="fade-up">
                    <div style="text-align: center; padding: 2rem 1rem;">
                        <div style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.2); padding: 0.5rem 1.5rem; border-radius: 50px; margin-bottom: 1rem; backdrop-filter: blur(10px);">
                            <i class="fas fa-chart-line" style="color: white; font-size: 1.2rem;"></i>
                            <span style="color: white; font-weight: 600; font-size: 1.1rem;">الرصيد الإجمالي</span>
                        </div>
                        <div style="font-size: 3.5rem; font-weight: 800; color: white; margin: 1rem 0; text-shadow: 0 4px 12px rgba(0,0,0,0.2); direction: ltr; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" id="total-balance">
                            <i class="fas fa-pound-sign" style="font-size: 2.5rem;"></i> 0
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
                            <button class="btn" style="background: white; color: #667eea; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; padding: 0.8rem 2rem; font-size: 1.1rem;" onclick="showPage('add-deposit'); document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));">
                                <i class="fas fa-plus-circle"></i> إيداع جديد
                            </button>
                            <button class="btn" style="background: rgba(239, 68, 68, 0.9); color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; padding: 0.8rem 2rem; font-size: 1.1rem;" onclick="showPage('add-withdrawal'); document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));">
                                <i class="fas fa-minus-circle"></i> سحب جديد
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" data-aos="fade-up" data-aos-delay="100">
                    <h2 class="card-header">
                        <i class="fas fa-chart-bar"></i>
                        الإحصائيات والرصيد الإجمالي
                    </h2>
                    <div class="stats">
                        <div class="stat-item" data-aos="zoom-in" data-aos-delay="100">
                            <i class="fas fa-wallet" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--primary-color);"></i>
                            <div class="stat-value" id="home-total-balance">0</div>
                            <div class="stat-label">الرصيد الحالي</div>
                        </div>
                        <div class="stat-item" data-aos="zoom-in" data-aos-delay="150">
                            <i class="fas fa-arrow-down" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--success-color);"></i>
                            <div class="stat-value" id="home-total-deposits-amount">0</div>
                            <div class="stat-label">إجمالي الإيداعات</div>
                        </div>
                        <div class="stat-item" data-aos="zoom-in" data-aos-delay="200">
                            <i class="fas fa-arrow-up" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--danger-color);"></i>
                            <div class="stat-value" id="home-total-expenses-amount">0</div>
                            <div class="stat-label">إجمالي المصروفات</div>
                        </div>
                        <div class="stat-item" data-aos="zoom-in" data-aos-delay="250">
                            <i class="fas fa-sort-amount-down" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #8b5cf6;"></i>
                            <div class="stat-value" id="total-deposits">0</div>
                            <div class="stat-label">عدد الإيداعات</div>
                        </div>
                        <div class="stat-item" data-aos="zoom-in" data-aos-delay="300">
                            <i class="fas fa-shopping-cart" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #f59e0b;"></i>
                            <div class="stat-value" id="total-expenses">0</div>
                            <div class="stat-label">عدد المصروفات</div>
                        </div>
                    </div>
                </div>

                <div class="card" data-aos="fade-up" data-aos-delay="150">
                    <h2 class="card-header">
                        <i class="fas fa-history"></i>
                        آخر الإيداعات
                    </h2>
                    <div id="recent-deposits"></div>
                </div>

                <div class="card" data-aos="fade-up" data-aos-delay="175">
                    <h2 class="card-header">
                        <i class="fas fa-hand-holding-usd"></i>
                        آخر السحوبات
                    </h2>
                    <div id="recent-withdrawals"></div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section" data-aos="fade-up" data-aos-delay="200">
                    <div class="chart-card">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-pie" style="color: var(--primary-color);"></i>
                            توزيع الإيداعات حسب الحالة
                        </h3>
                        <canvas id="depositsStatusChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-line" style="color: var(--success-color);"></i>
                            الإيداعات والمصروفات
                        </h3>
                        <canvas id="depositsVsExpensesChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="add-deposit" class="page">
                <div class="card" data-aos="fade-up">
                    <h2 class="card-header">
                        <i class="fas fa-plus-circle"></i>
                        إضافة إيداع جديد
                    </h2>
                    <form id="deposit-form">
                        <div class="form-group">
                            <label for="depositor-name"><i class="fas fa-user"></i> اسم العضو</label>
                            <input type="text" id="depositor-name" placeholder="أدخل اسمك الكامل" required>
                        </div>
                        <div class="form-group">
                            <label for="depositor-phone"><i class="fas fa-phone"></i> رقم الهاتف المحول منه</label>
                            <input type="tel" id="depositor-phone" placeholder="أدخل رقم الهاتف" required>
                        </div>
                        <div class="form-group">
                            <label for="deposit-amount"><i class="fas fa-money-bill-wave"></i> المبلغ (جنيه)</label>
                            <input type="number" id="deposit-amount" min="1" placeholder="أدخل المبلغ" required>
                        </div>
                        <div class="form-group">
                            <label for="deposit-proof"><i class="fas fa-image"></i> صورة إثبات التحويل</label>
                            <input type="file" id="deposit-proof" accept="image/*" required>
                            <img id="proof-preview" class="image-preview" alt="معاينة الصورة">
                        </div>
                        <div class="wallet-info" id="payment-methods-display">
                            <!-- سيتم عرض طرق الدفع ديناميكياً -->
                        </div>
                        <button type="submit"><i class="fas fa-paper-plane"></i> إضافة الإيداع</button>
                    </form>
                </div>
            </section>

            <section id="add-withdrawal" class="page">
                <div class="card" data-aos="fade-up">
                    <h2 class="card-header">
                        <i class="fas fa-minus-circle"></i>
                        إضافة عملية سحب جديدة
                    </h2>
                    <form id="withdrawal-form">
                        <div class="form-group">
                            <label for="withdrawal-name"><i class="fas fa-user"></i> اسم العضو</label>
                            <input type="text" id="withdrawal-name" placeholder="أدخل اسمك الكامل" required>
                        </div>
                        <div class="form-group">
                            <label for="withdrawal-phone"><i class="fas fa-phone"></i> رقم الهاتف المحول إليه</label>
                            <input type="tel" id="withdrawal-phone" placeholder="أدخل رقم الهاتف" required>
                        </div>
                        <div class="form-group">
                            <label for="withdrawal-amount"><i class="fas fa-money-bill-wave"></i> المبلغ (جنيه)</label>
                            <input type="number" id="withdrawal-amount" min="1" placeholder="أدخل المبلغ" required>
                        </div>
                        <div class="form-group">
                            <label for="withdrawal-reason"><i class="fas fa-comment"></i> سبب السحب</label>
                            <textarea id="withdrawal-reason" placeholder="اكتب سبب السحب (اختياري)"></textarea>
                        </div>
                        <div class="wallet-info" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%); border-right: 4px solid var(--danger-color);">
                            <p><i class="fas fa-exclamation-triangle"></i> تنبيه:</p>
                            <p style="color: var(--danger-color); font-weight: 600;">سيتم مراجعة طلب السحب والموافقة عليه من قبل الإدارة</p>
                        </div>
                        <button type="submit" style="background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);"><i class="fas fa-paper-plane"></i> تقديم طلب السحب</button>
                    </form>
                </div>
            </section>

            <section id="deposits" class="page">
                <div style="display: grid; grid-template-columns: 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="card" data-aos="fade-up">
                        <h2 class="card-header"><i class="fas fa-arrow-down"></i> سجل الإيداعات</h2>
                        
                        <!-- Search and Filter -->
                        <div class="search-filter-section">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="deposits-search" placeholder="ابحث عن اسم أو رقم هاتف..." onkeyup="filterDeposits()">
                            </div>
                            <div class="filter-group">
                                <button class="filter-btn active" onclick="filterByStatus('all')" data-status="all"><i class="fas fa-list"></i> الكل</button>
                                <button class="filter-btn" onclick="filterByStatus('pending')" data-status="pending"><i class="fas fa-clock"></i> معلق</button>
                                <button class="filter-btn" onclick="filterByStatus('approved')" data-status="approved"><i class="fas fa-check"></i> مقبول</button>
                                <button class="filter-btn" onclick="filterByStatus('rejected')" data-status="rejected"><i class="fas fa-times"></i> مرفوض</button>
                            </div>
                        </div>
                        
                        <div class="deposits-container">
                            <table class="deposits-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable('deposits-list', 0)"><i class="fas fa-user"></i> الاسم <span class="sort-indicator">↕</span></th>
                                        <th onclick="sortTable('deposits-list', 1)"><i class="fas fa-phone"></i> الهاتف <span class="sort-indicator">↕</span></th>
                                        <th onclick="sortTable('deposits-list', 2)"><i class="fas fa-coins"></i> المبلغ <span class="sort-indicator">↕</span></th>
                                        <th onclick="sortTable('deposits-list', 3)"><i class="fas fa-calendar"></i> التاريخ <span class="sort-indicator">↕</span></th>
                                        <th><i class="fas fa-check-circle"></i> الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="deposits-list"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card" data-aos="fade-up" data-aos-delay="100">
                        <h2 class="card-header"><i class="fas fa-hand-holding-usd"></i> سجل السحوبات</h2>
                        
                        <!-- Search and Filter -->
                        <div class="search-filter-section">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="withdrawals-search" placeholder="ابحث عن اسم أو رقم هاتف..." onkeyup="filterWithdrawals()">
                            </div>
                            <div class="filter-group">
                                <button class="filter-btn active" onclick="filterWithdrawalsByStatus('all')" data-status="all"><i class="fas fa-list"></i> الكل</button>
                                <button class="filter-btn" onclick="filterWithdrawalsByStatus('pending')" data-status="pending"><i class="fas fa-clock"></i> معلق</button>
                                <button class="filter-btn" onclick="filterWithdrawalsByStatus('approved')" data-status="approved"><i class="fas fa-check"></i> مقبول</button>
                                <button class="filter-btn" onclick="filterWithdrawalsByStatus('rejected')" data-status="rejected"><i class="fas fa-times"></i> مرفوض</button>
                            </div>
                        </div>
                        
                        <div class="deposits-container">
                            <table class="deposits-table">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-user"></i> الاسم</th>
                                        <th><i class="fas fa-phone"></i> الهاتف</th>
                                        <th><i class="fas fa-coins"></i> المبلغ</th>
                                        <th><i class="fas fa-comment"></i> السبب</th>
                                        <th><i class="fas fa-calendar"></i> التاريخ</th>
                                        <th><i class="fas fa-check-circle"></i> الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawals-list"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card" data-aos="fade-up" data-aos-delay="200">
                        <h2 class="card-header"><i class="fas fa-arrow-up"></i> سجل المصروفات</h2>
                        <div style="overflow-x: auto;">
                            <table class="deposits-table">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-pen"></i> الوصف</th>
                                        <th><i class="fas fa-tag"></i> الفئة</th>
                                        <th><i class="fas fa-coins"></i> المبلغ</th>
                                        <th><i class="fas fa-calendar"></i> التاريخ</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="admin" class="page">
                <div id="admin-login-section" class="card admin-login" data-aos="zoom-in">
                    <h2 class="card-header"><i class="fas fa-lock"></i> تسجيل دخول الإدارة</h2>
                    <form id="admin-login-form">
                        <div class="form-group">
                            <label for="admin-username"><i class="fas fa-user"></i> اسم المستخدم</label>
                            <input type="text" id="admin-username" placeholder="أدخل اسم المستخدم" required>
                        </div>
                        <div class="form-group">
                            <label for="admin-password"><i class="fas fa-key"></i> كلمة المرور</label>
                            <input type="password" id="admin-password" placeholder="أدخل كلمة المرور" required>
                        </div>
                        <button type="submit"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</button>
                    </form>
                </div>

                <div id="admin-dashboard" style="display: none;">
                    <div style="text-align: left; margin-bottom: 1.5rem;">
                        <button class="btn btn-danger" onclick="adminLogout();" style="background-color: var(--danger-color); border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem;">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </button>
                    </div>

                    <div class="card admin-section" data-aos="fade-up">
                        <h2 class="card-header"><i class="fas fa-chart-bar"></i> الإحصائيات</h2>
                        <div class="stats">
                            <div class="stat-item" data-aos="zoom-in" data-aos-delay="300">
                                <i class="fas fa-arrow-down" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--success-color);"></i>
                                <div class="stat-value" id="admin-total-deposits">0</div>
                                <div class="stat-label">إجمالي الإيداعات</div>
                            </div>
                            <div class="stat-item" data-aos="zoom-in" data-aos-delay="400">
                                <i class="fas fa-arrow-up" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--danger-color);"></i>
                                <div class="stat-value" id="admin-total-expenses">0</div>
                                <div class="stat-label">إجمالي المصروفات</div>
                            </div>
                            <div class="stat-item" data-aos="zoom-in" data-aos-delay="500">
                                <i class="fas fa-wallet" style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--primary-color);"></i>
                                <div class="stat-value" id="admin-current-balance">0</div>
                                <div class="stat-label">الرصيد الحالي</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card admin-section" data-aos="fade-up" data-aos-delay="100">
                        <h2 class="card-header"><i class="fas fa-cash-register"></i> إضافة مصروفات</h2>
                        <form id="expense-form">
                            <div class="form-group">
                                <label for="expense-description"><i class="fas fa-pen"></i> وصف المصروف</label>
                                <input type="text" id="expense-description" placeholder="أدخل وصف المصروف" required>
                            </div>
                            <div class="form-group">
                                <label for="expense-category"><i class="fas fa-tag"></i> التصنيف</label>
                                <input type="text" id="expense-category" placeholder="أدخل التصنيف " required>
                            </div>
                            <div class="form-group">
                                <label for="expense-amount"><i class="fas fa-money-bill-wave"></i> المبلغ (جنيه)</label>
                                <input type="number" id="expense-amount" min="1" placeholder="أدخل المبلغ" required>
                            </div>
                            <button type="submit" class="btn-danger"><i class="fas fa-plus"></i> إضافة المصروف</button>
                        </form>
                    </div>
                    
                    <div class="card admin-section" data-aos="fade-up" data-aos-delay="150">
                        <div class="admin-tabs">
                            <div class="tab-headers">
                                <button class="tab-header active" onclick="switchAdminTab('deposits')">
                                    <i class="fas fa-arrow-down"></i> الإيداعات
                                </button>
                                <button class="tab-header" onclick="switchAdminTab('expenses')">
                                    <i class="fas fa-shopping-cart"></i> المصروفات
                                </button>
                                <button class="tab-header" onclick="switchAdminTab('withdrawals')">
                                    <i class="fas fa-hand-holding-usd"></i> السحوبات
                                </button>
                            </div>
                            
                            <div class="tab-content">
                                <!-- إدارة الإيداعات -->
                                <div id="admin-tab-deposits" class="tab-pane active">
                                    <div class="admin-filters">
                                        <div class="search-box" style="flex: 1;">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="admin-deposits-search" placeholder="بحث بالاسم أو رقم الهاتف..." onkeyup="filterAdminDeposits()">
                                        </div>
                                        <div class="filter-buttons">
                                            <button class="filter-btn active" onclick="filterAdminDepositsByStatus('all')">
                                                <i class="fas fa-list"></i> الكل
                                            </button>
                                            <button class="filter-btn" onclick="filterAdminDepositsByStatus('pending')">
                                                <i class="fas fa-clock"></i> معلق
                                            </button>
                                            <button class="filter-btn" onclick="filterAdminDepositsByStatus('approved')">
                                                <i class="fas fa-check-circle"></i> مقبول
                                            </button>
                                            <button class="filter-btn" onclick="filterAdminDepositsByStatus('rejected')">
                                                <i class="fas fa-times-circle"></i> مرفوض
                                            </button>
                                        </div>
                                    </div>
                                    <div style="overflow-x: auto;">
                                        <table class="deposits-table">
                                            <thead>
                                                <tr>
                                                    <th><i class="fas fa-user"></i> الاسم</th>
                                                    <th><i class="fas fa-phone"></i> الهاتف</th>
                                                    <th><i class="fas fa-coins"></i> المبلغ</th>
                                                    <th><i class="fas fa-calendar"></i> التاريخ</th>
                                                    <th><i class="fas fa-check-circle"></i> الحالة</th>
                                                    <th><i class="fas fa-cog"></i> الإجراءات</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-deposits-list"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- إدارة المصروفات -->
                                <div id="admin-tab-expenses" class="tab-pane">
                                    <div class="admin-filters">
                                        <div class="search-box" style="flex: 1;">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="admin-expenses-search" placeholder="بحث بالوصف أو الفئة..." onkeyup="filterAdminExpenses()">
                                        </div>
                                    </div>
                                    <div style="overflow-x: auto;">
                                        <table class="deposits-table">
                                            <thead>
                                                <tr>
                                                    <th><i class="fas fa-pen"></i> الوصف</th>
                                                    <th><i class="fas fa-tag"></i> الفئة</th>
                                                    <th><i class="fas fa-coins"></i> المبلغ</th>
                                                    <th><i class="fas fa-calendar"></i> التاريخ</th>
                                                    <th><i class="fas fa-cog"></i> الإجراءات</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-expenses-list"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- إدارة السحوبات -->
                                <div id="admin-tab-withdrawals" class="tab-pane">
                                    <div class="admin-filters">
                                        <div class="search-box" style="flex: 1;">
                                            <i class="fas fa-search"></i>
                                            <input type="text" id="admin-withdrawals-search" placeholder="بحث بالاسم أو رقم الهاتف..." onkeyup="filterAdminWithdrawals()">
                                        </div>
                                        <div class="filter-buttons">
                                            <button class="filter-btn active" onclick="filterAdminWithdrawalsByStatus('all')">
                                                <i class="fas fa-list"></i> الكل
                                            </button>
                                            <button class="filter-btn" onclick="filterAdminWithdrawalsByStatus('pending')">
                                                <i class="fas fa-clock"></i> معلق
                                            </button>
                                            <button class="filter-btn" onclick="filterAdminWithdrawalsByStatus('approved')">
                                                <i class="fas fa-check-circle"></i> مقبول
                                            </button>
                                            <button class="filter-btn" onclick="filterAdminWithdrawalsByStatus('rejected')">
                                                <i class="fas fa-times-circle"></i> مرفوض
                                            </button>
                                        </div>
                                    </div>
                                    <div style="overflow-x: auto;">
                                        <table class="deposits-table">
                                            <thead>
                                                <tr>
                                                    <th><i class="fas fa-user"></i> الاسم</th>
                                                    <th><i class="fas fa-phone"></i> الهاتف</th>
                                                    <th><i class="fas fa-coins"></i> المبلغ</th>
                                                    <th><i class="fas fa-comment"></i> السبب</th>
                                                    <th><i class="fas fa-calendar"></i> التاريخ</th>
                                                    <th><i class="fas fa-check-circle"></i> الحالة</th>
                                                    <th><i class="fas fa-cog"></i> الإجراءات</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-withdrawals-list"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card admin-section" data-aos="fade-up" data-aos-delay="75">
                        <h2 class="card-header"><i class="fas fa-print"></i> طباعة التقارير</h2>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; padding: 1rem;">
                            <button class="btn" onclick="printBalanceReport()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);">
                                <i class="fas fa-file-invoice-dollar"></i> تقرير الرصيد الكامل
                            </button>
                            <button class="btn" onclick="printDepositsReport()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);">
                                <i class="fas fa-file-download"></i> تقرير الإيداعات
                            </button>
                            <button class="btn" onclick="printExpensesWithdrawalsReport()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);">
                                <i class="fas fa-file-upload"></i> تقرير المصروفات والسحوبات
                            </button>
                        </div>
                    </div>
                    
                    <div class="card admin-section" data-aos="fade-up" data-aos-delay="50" style="border: 2px solid var(--danger-color);">
                        <h2 class="card-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%); color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle"></i> منطقة الخطر
                        </h2>
                        <div style="padding: 1.5rem;">
                            <p style="color: var(--gray-color); margin-bottom: 1rem;">
                                <i class="fas fa-info-circle"></i> حذف جميع البيانات سيؤدي لمسح كل الإيداعات والمصروفات والسحوبات بشكل نهائي ولا يمكن التراجع.
                            </p>
                            <button class="btn" onclick="deleteAllData()" style="background: linear-gradient(135deg, var(--danger-color) 0%, #b91c1c 100%); width: 100%; font-weight: 600;">
                                <i class="fas fa-database"></i> حذف جميع البيانات من Google Sheets
                            </button>
                        </div>
                    </div>

                    <!-- إعدادات طرق الدفع -->
                    <div class="card admin-section" data-aos="fade-up" data-aos-delay="100">
                        <h2 class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <i class="fas fa-credit-card"></i> إعدادات طرق الدفع
                        </h2>
                        <div style="padding: 1.5rem;">
                            <form id="payment-settings-form" style="display: grid; gap: 1.5rem;">
                                
                                <!-- إنستاباي -->
                                <div style="background: rgba(102, 126, 234, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                        <i class="fas fa-mobile-alt" style="font-size: 2rem; color: #667eea;"></i>
                                        <h3 style="margin: 0; color: #667eea;">إنستاباي (Instapay)</h3>
                                    </div>
                                    <div class="form-group">
                                        <label for="instapay-number"><i class="fas fa-hashtag"></i> رقم الهاتف</label>
                                        <input type="tel" id="instapay-number" placeholder="مثال: 01097612534">
                                    </div>
                                    <div class="form-group">
                                        <label for="instapay-name"><i class="fas fa-user"></i> الاسم المسجل</label>
                                        <input type="text" id="instapay-name" placeholder="مثال: محمد أحمد">
                                    </div>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" id="instapay-enabled">
                                        <span class="checkmark"></span>
                                        <span class="checkbox-label">تفعيل هذه الطريقة</span>
                                    </label>
                                </div>

                                <!-- محافظ إلكترونية -->
                                <div style="background: rgba(16, 185, 129, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                        <i class="fas fa-wallet" style="font-size: 2rem; color: #10b981;"></i>
                                        <h3 style="margin: 0; color: #10b981;">محافظ إلكترونية</h3>
                                    </div>
                                    <div class="form-group">
                                        <label for="ewallet-type"><i class="fas fa-list"></i> نوع المحفظة</label>
                                        <select id="ewallet-type" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color);">
                                            <option value="">اختر نوع المحفظة</option>
                                            <option value="vodafone-cash">فودافون كاش</option>
                                            <option value="orange-cash">أورانج كاش</option>
                                            <option value="etisalat-cash">اتصالات كاش</option>
                                            <option value="we-pay">WE Pay</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="ewallet-number"><i class="fas fa-hashtag"></i> رقم المحفظة</label>
                                        <input type="tel" id="ewallet-number" placeholder="مثال: 01012345678">
                                    </div>
                                    <div class="form-group">
                                        <label for="ewallet-name"><i class="fas fa-user"></i> الاسم المسجل</label>
                                        <input type="text" id="ewallet-name" placeholder="مثال: محمد أحمد">
                                    </div>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" id="ewallet-enabled">
                                        <span class="checkmark"></span>
                                        <span class="checkbox-label">تفعيل هذه الطريقة</span>
                                    </label>
                                </div>

                                <!-- حساب بنكي -->
                                <div style="background: rgba(239, 68, 68, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                        <i class="fas fa-university" style="font-size: 2rem; color: #ef4444;"></i>
                                        <h3 style="margin: 0; color: #ef4444;">حساب بنكي</h3>
                                    </div>
                                    <div class="form-group">
                                        <label for="bank-name"><i class="fas fa-building"></i> اسم البنك</label>
                                        <input type="text" id="bank-name" placeholder="مثال: البنك الأهلي المصري">
                                    </div>
                                    <div class="form-group">
                                        <label for="bank-account"><i class="fas fa-hashtag"></i> رقم الحساب</label>
                                        <input type="text" id="bank-account" placeholder="مثال: 1234567890">
                                    </div>
                                    <div class="form-group">
                                        <label for="bank-holder"><i class="fas fa-user"></i> اسم صاحب الحساب</label>
                                        <input type="text" id="bank-holder" placeholder="مثال: محمد أحمد">
                                    </div>
                                    <div class="form-group">
                                        <label for="bank-iban"><i class="fas fa-barcode"></i> IBAN (اختياري)</label>
                                        <input type="text" id="bank-iban" placeholder="مثال: EG380002001234567890123456789">
                                    </div>
                                    <label class="custom-checkbox">
                                        <input type="checkbox" id="bank-enabled">
                                        <span class="checkmark"></span>
                                        <span class="checkbox-label">تفعيل هذه الطريقة</span>
                                    </label>
                                </div>

                                <button type="button" onclick="savePaymentSettings()" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600; padding: 1rem;">
                                    <i class="fas fa-save"></i> حفظ التغييرات
                                </button>
                            </form>
                        </div>
                    </div>
                   
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <p><i class="fas fa-wallet"></i> فلوسنا - المحفظة الجماعية<br><small>&copy; 2025 جميع الحقوق محفوظة</small></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>
        AOS.init({duration: 800, easing: 'ease-in-out-cubic', once: true, offset: 100});

        // دالة لدعم النصوص العربية في PDF
        function reverseArabicText(text) {
            // هذه دالة مساعدة لعكس النص العربي
            // في الواقع، jsPDF يتعامل مع العربية مباشرة
            return text;
        }

        // تسجيل خط Arial لدعم العربية
        if (typeof window.jsPDF !== 'undefined') {
            const { jsPDF } = window.jspdf;
            // استخدام font helvetica كبديل آمن
        }

        let appData = {
            deposits: [], 
            expenses: [], 
            withdrawals: [], 
            adminLoggedIn: false, 
            adminCredentials: {username: "admin", password: "admin123"},
            paymentMethods: {
                instapay: {enabled: false, number: '', name: ''},
                ewallet: {enabled: false, type: '', number: '', name: ''},
                bank: {enabled: false, bankName: '', account: '', holder: '', iban: ''}
            }
        };

        // ========== نظام Toast Notifications ==========
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) {
                console.error('❌ Toast container not found!');
                return;
            }
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            toast.innerHTML = `
                <i class="toast-icon ${icons[type]}"></i>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.style.transition = 'all 0.3s ease-out';
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // ========== نظام الإشعارات المميزة ==========
        function showSuccessModal(title, message, icon = '✅') {
            // إنشاء overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            // إنشاء النافذة المنبثقة
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                animation: slideUp 0.4s ease;
                position: relative;
            `;
            
            modal.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 20px;">${icon}</div>
                <h2 style="color: white; font-size: 28px; margin-bottom: 15px; font-weight: bold;">${title}</h2>
                <p style="color: rgba(255, 255, 255, 0.95); font-size: 18px; line-height: 1.6; margin-bottom: 30px;">${message}</p>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="
                    background: white;
                    color: #667eea;
                    border: none;
                    padding: 15px 40px;
                    border-radius: 12px;
                    font-size: 18px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <i class="fas fa-check"></i> حسناً
                </button>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // إزالة تلقائية بعد 5 ثوانٍ
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => overlay.remove(), 300);
                }
            }, 5000);
        }

        // إرسال إشعار خلفية للأدمن عبر Telegram
        async function notifyAdmin(type, data) {
            const ADMIN_BOT_TOKEN = '8428360847:AAEzE-NPm1EImgnq70Qu4iAacQB5XeVBi_8';
            const ADMIN_CHAT_ID = '5773416612';
            
            let message = '';
            if (type === 'deposit') {
                message = `🔔 <b>طلب إيداع جديد</b>

👤 <b>الاسم:</b> ${data.name}
📱 <b>الهاتف:</b> ${data.phone}
💰 <b>المبلغ:</b> ${data.amount} جنيه
📅 <b>التاريخ:</b> ${data.date}

⏳ <i>بانتظار الموافقة في لوحة التحكم</i>`;
            } else if (type === 'withdrawal') {
                message = `🔔 <b>طلب سحب جديد</b>

👤 <b>الاسم:</b> ${data.name}
📱 <b>الهاتف:</b> ${data.phone}
💸 <b>المبلغ:</b> ${data.amount} جنيه
📝 <b>السبب:</b> ${data.reason}
📅 <b>التاريخ:</b> ${data.date}

⏳ <i>بانتظار الموافقة في لوحة التحكم</i>`;
            }
            
            try {
                const url = `https://api.telegram.org/bot${ADMIN_BOT_TOKEN}/sendMessage`;
                const params = {
                    chat_id: ADMIN_CHAT_ID,
                    text: message,
                    parse_mode: 'HTML'
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const result = await response.json();
                if (result.ok) {
                    console.log('✅ تم إرسال إشعار للأدمن');
                } else {
                    console.error('❌ فشل إرسال إشعار للأدمن:', result);
                }
            } catch (error) {
                console.error('❌ خطأ في إرسال إشعار للأدمن:', error);
            }
        }

        // ========== إعدادات Google Sheets و Telegram ==========
        const GOOGLE_SHEETS_CONFIG = {
            enabled: true, // ✅ مفعّل
            scriptUrl: 'https://script.google.com/macros/s/AKfycbw4M1gtqb_-zlfag-w38w9LznubSOydvlnVDgUundQEPmscosLm1fwFEsjXimM_ic8I/exec'
        };

        const TELEGRAM_CONFIG = {
            enabled: true,
            botToken: '8299247400:AAHOJU7qIanXJrvHEaryAkx5uL_MK8DTzOg',
            chatId: '5773416612'
        };

        // متغير للتحميل
        let isLoading = false;

        // ========== دوال Google Sheets (قاعدة البيانات الرئيسية) ==========
        
        // جلب جميع البيانات من Google Sheets
        async function fetchDataFromGoogleSheets() {
            if (!GOOGLE_SHEETS_CONFIG.enabled || !GOOGLE_SHEETS_CONFIG.scriptUrl) {
                console.log('⚠️ Google Sheets غير مفعل - استخدام LocalStorage');
                return null;
            }

            showLoading(true);
            try {
                // استخدام GET بدلاً من POST لتجنب مشاكل CORS
                const payload = {action: 'getAll'};
                const url = new URL(GOOGLE_SHEETS_CONFIG.scriptUrl);
                url.searchParams.append('data', JSON.stringify(payload));
                
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log('✅ تم جلب البيانات من Google Sheets');
                    return result.data;
                } else {
                    console.error('❌ خطأ:', result.message);
                    showToast('فشل جلب البيانات من السحابة', 'error');
                    return null;
                }
            } catch (error) {
                console.error('❌ خطأ في الاتصال بـ Google Sheets:', error);
                showToast('خطأ في الاتصال بقاعدة البيانات', 'error');
                return null;
            } finally {
                showLoading(false);
            }
        }

        // إرسال بيانات إلى Google Sheets
        async function sendToGoogleSheets(action, data) {
            if (!GOOGLE_SHEETS_CONFIG.enabled || !GOOGLE_SHEETS_CONFIG.scriptUrl) {
                console.log('⚠️ Google Sheets غير مفعل');
                return {status: 'error', message: 'Google Sheets not enabled'};
            }

            showLoading(true);
            try {
                const payload = {action: action, ...data};
                
                // استخدام GET بدلاً من POST لتجنب مشاكل CORS
                const url = new URL(GOOGLE_SHEETS_CONFIG.scriptUrl);
                url.searchParams.append('data', JSON.stringify(payload));
                
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('❌ خطأ في إرسال البيانات:', error);
                return {status: 'error', message: error.message};
            } finally {
                showLoading(false);
            }
        }

        // عرض/إخفاء شاشة التحميل
        function showLoading(show) {
            isLoading = show;
            const spinner = document.getElementById('loading-spinner');
            if (spinner) {
                spinner.style.display = show ? 'flex' : 'none';
            }
        }

        // ========== دوال Telegram ==========
        async function sendTelegramNotification(message) {
            if (!TELEGRAM_CONFIG.enabled || !TELEGRAM_CONFIG.botToken || !TELEGRAM_CONFIG.chatId) {
                console.warn('⚠️ Telegram غير مفعل أو معلومات الاتصال ناقصة');
                return;
            }

            try {
                const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.botToken}/sendMessage`;
                const payload = {
                    chat_id: TELEGRAM_CONFIG.chatId,
                    text: message.trim(),
                    parse_mode: 'HTML'
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    return true;
                } else {
                    console.error('❌ خطأ من Telegram API:', result.description);
                    return false;
                }
            } catch (error) {
                console.error('❌ خطأ في إرسال الإشعار إلى Telegram:', error);
                console.error('تفاصيل الخطأ:', error.message);
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            checkAdminLoginStatus();
            loadPaymentSettings();
            updatePaymentMethodsDisplay();
            updateUI();
        });

        // ========== إدارة طرق الدفع ==========
        
        function savePaymentSettings() {
            try {
                // التحقق من وجود العناصر
                const elements = {
                    instapayEnabled: document.getElementById('instapay-enabled'),
                    instapayNumber: document.getElementById('instapay-number'),
                    instapayName: document.getElementById('instapay-name'),
                    ewalletEnabled: document.getElementById('ewallet-enabled'),
                    ewalletType: document.getElementById('ewallet-type'),
                    ewalletNumber: document.getElementById('ewallet-number'),
                    ewalletName: document.getElementById('ewallet-name'),
                    bankEnabled: document.getElementById('bank-enabled'),
                    bankName: document.getElementById('bank-name'),
                    bankAccount: document.getElementById('bank-account'),
                    bankHolder: document.getElementById('bank-holder'),
                    bankIban: document.getElementById('bank-iban')
                };
                
                // التحقق من أن جميع العناصر موجودة
                for (let key in elements) {
                    if (!elements[key]) {
                        console.error('❌ العنصر غير موجود:', key);
                        showToast('خطأ: لم يتم العثور على جميع الحقول المطلوبة', 'error');
                        return;
                    }
                }
                
                const paymentMethods = {
                    instapay: {
                        enabled: elements.instapayEnabled.checked,
                        number: elements.instapayNumber.value.trim(),
                        name: elements.instapayName.value.trim()
                    },
                    ewallet: {
                        enabled: elements.ewalletEnabled.checked,
                        type: elements.ewalletType.value,
                        number: elements.ewalletNumber.value.trim(),
                        name: elements.ewalletName.value.trim()
                    },
                    bank: {
                        enabled: elements.bankEnabled.checked,
                        bankName: elements.bankName.value.trim(),
                        account: elements.bankAccount.value.trim(),
                        holder: elements.bankHolder.value.trim(),
                        iban: elements.bankIban.value.trim()
                    }
                };
                
                appData.paymentMethods = paymentMethods;
                saveDataLocally();
                
                showToast('تم حفظ إعدادات طرق الدفع بنجاح', 'success');
                updatePaymentMethodsDisplay();
            } catch (error) {
                console.error('❌ خطأ في حفظ الإعدادات:', error);
                showToast('حدث خطأ أثناء الحفظ: ' + error.message, 'error');
            }
        }

        function loadPaymentSettings() {
            if (!appData.paymentMethods) {
                appData.paymentMethods = {
                    instapay: {enabled: false, number: '', name: ''},
                    ewallet: {enabled: false, type: '', number: '', name: ''},
                    bank: {enabled: false, bankName: '', account: '', holder: '', iban: ''}
                };
            }
            
            const pm = appData.paymentMethods;
            
            // تحميل إنستاباي
            if (document.getElementById('instapay-enabled')) {
                document.getElementById('instapay-enabled').checked = pm.instapay.enabled || false;
                document.getElementById('instapay-number').value = pm.instapay.number || '';
                document.getElementById('instapay-name').value = pm.instapay.name || '';
            }
            
            // تحميل المحافظ
            if (document.getElementById('ewallet-enabled')) {
                document.getElementById('ewallet-enabled').checked = pm.ewallet.enabled || false;
                document.getElementById('ewallet-type').value = pm.ewallet.type || '';
                document.getElementById('ewallet-number').value = pm.ewallet.number || '';
                document.getElementById('ewallet-name').value = pm.ewallet.name || '';
            }
            
            // تحميل البنك
            if (document.getElementById('bank-enabled')) {
                document.getElementById('bank-enabled').checked = pm.bank.enabled || false;
                document.getElementById('bank-name').value = pm.bank.bankName || '';
                document.getElementById('bank-account').value = pm.bank.account || '';
                document.getElementById('bank-holder').value = pm.bank.holder || '';
                document.getElementById('bank-iban').value = pm.bank.iban || '';
            }
            
            updatePaymentMethodsDisplay();
        }

        function updatePaymentMethodsDisplay() {
            const container = document.getElementById('payment-methods-display');
            if (!container) return;
            
            const pm = appData.paymentMethods;
            let html = '<div style="margin-bottom: 1rem;"><strong><i class="fas fa-info-circle"></i> طرق الدفع المتاحة:</strong></div>';
            
            let hasAnyMethod = false;
            
            // إنستاباي
            if (pm.instapay && pm.instapay.enabled && pm.instapay.number) {
                hasAnyMethod = true;
                html += `
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-right: 4px solid #667eea;">
                        <p style="margin: 0 0 0.5rem 0;"><i class="fas fa-mobile-alt" style="color: #667eea;"></i> <strong>إنستاباي (Instapay)</strong></p>
                        <p style="margin: 0; font-size: 1.1rem; color: #667eea; font-weight: bold;">${pm.instapay.number}</p>
                        ${pm.instapay.name ? `<p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">باسم: ${pm.instapay.name}</p>` : ''}
                    </div>
                `;
            }
            
            // محفظة إلكترونية
            if (pm.ewallet && pm.ewallet.enabled && pm.ewallet.number) {
                hasAnyMethod = true;
                const walletTypes = {
                    'vodafone-cash': 'فودافون كاش',
                    'orange-cash': 'أورانج كاش',
                    'etisalat-cash': 'اتصالات كاش',
                    'we-pay': 'WE Pay'
                };
                const walletName = walletTypes[pm.ewallet.type] || 'محفظة إلكترونية';
                
                html += `
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-right: 4px solid #10b981;">
                        <p style="margin: 0 0 0.5rem 0;"><i class="fas fa-wallet" style="color: #10b981;"></i> <strong>${walletName}</strong></p>
                        <p style="margin: 0; font-size: 1.1rem; color: #10b981; font-weight: bold;">${pm.ewallet.number}</p>
                        ${pm.ewallet.name ? `<p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">باسم: ${pm.ewallet.name}</p>` : ''}
                    </div>
                `;
            }
            
            // حساب بنكي
            if (pm.bank && pm.bank.enabled && pm.bank.account) {
                hasAnyMethod = true;
                html += `
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem; border-right: 4px solid #ef4444;">
                        <p style="margin: 0 0 0.5rem 0;"><i class="fas fa-university" style="color: #ef4444;"></i> <strong>حساب بنكي</strong></p>
                        ${pm.bank.bankName ? `<p style="margin: 0 0 0.25rem 0; font-size: 0.9rem;">${pm.bank.bankName}</p>` : ''}
                        <p style="margin: 0; font-size: 1.1rem; color: #ef4444; font-weight: bold;">${pm.bank.account}</p>
                        ${pm.bank.holder ? `<p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">باسم: ${pm.bank.holder}</p>` : ''}
                        ${pm.bank.iban ? `<p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #666;">IBAN: ${pm.bank.iban}</p>` : ''}
                    </div>
                `;
            }
            
            if (!hasAnyMethod) {
                html = `
                    <div class="wallet-info" style="background: rgba(239, 68, 68, 0.1); border-right: 4px solid var(--danger-color);">
                        <p><i class="fas fa-exclamation-triangle"></i> لم يتم تفعيل أي طريقة دفع</p>
                        <p style="font-size: 0.9rem; color: var(--gray-color);">يرجى التواصل مع الإدارة لمعرفة طرق الدفع المتاحة</p>
                    </div>
                `;
            } else {
                html += `
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray-color);">
                        <i class="fas fa-info-circle"></i> يرجى إرفاق صورة إثبات التحويل بعد الإيداع
                    </p>
                `;
            }
            
            container.innerHTML = html;
        }

        // تحميل البيانات من Google Sheets أو LocalStorage
        async function loadData() {
            // محاولة جلب البيانات من Google Sheets
            const cloudData = await fetchDataFromGoogleSheets();
            
            if (cloudData) {
                // تحويل البيانات من العربية إلى الإنجليزية
                appData.deposits = (cloudData.deposits || []).map(d => ({
                    id: d.ID || d.id,
                    name: d.الاسم || d.name || '',
                    phone: d.الهاتف || d.phone || '',
                    amount: parseAmount(d.المبلغ || d.amount),
                    date: d.التاريخ || d.date || '',
                    status: translateStatus(d.الحالة || d.status || 'pending'),
                    proof: d.صورة_التحويل || d.proof || ''
                }));
                
                appData.expenses = (cloudData.expenses || []).map(e => ({
                    id: e.ID || e.id,
                    description: e.الوصف || e.description || '',
                    category: e.الفئة || e.category || '',
                    amount: parseAmount(e.المبلغ || e.amount),
                    date: e.التاريخ || e.date || ''
                }));
                
                appData.withdrawals = (cloudData.withdrawals || []).map(w => ({
                    id: w.ID || w.id,
                    date: w.التاريخ || w.date || '',
                    name: w.الاسم || w.name || '',
                    phone: w.الهاتف || w.phone || '',
                    amount: parseAmount(w.المبلغ || w.amount),
                    reason: w.السبب || w.reason || '',
                    status: translateStatus(w.الحالة || w.status || 'pending')
                }));
                
                // حفظ نسخة محلية كـ cache
                saveDataLocally();
            } else {
                // استخدام البيانات المحلية (LocalStorage) كخطة احتياطية
                const savedData = localStorage.getItem('flosnaData');
                if (savedData) {
                    appData = JSON.parse(savedData);
                    if (!appData.withdrawals) {
                        appData.withdrawals = [];
                    }
                }
            }
            
            // تنظيف الصور القديمة
            cleanOldImages();
            
            // تحديث الواجهة بعد تحميل البيانات
            updateUI();
        }
        
        // تحويل الحالة من العربية إلى الإنجليزية
        function translateStatus(arabicStatus) {
            const statusMap = {
                'معلق': 'pending',
                'مقبول': 'approved',
                'مرفوض': 'rejected'
            };
            return statusMap[arabicStatus] || arabicStatus;
        }
        
        // تحويل المبلغ إلى رقم بشكل آمن
        function parseAmount(value) {
            if (value === null || value === undefined || value === '') return 0;
            // إزالة أي أحرف غير رقمية وتحويل إلى رقم
            const cleaned = String(value).replace(/[^\d]/g, '');
            const num = parseInt(cleaned, 10);
            return isNaN(num) ? 0 : num;
        }

        // حفظ البيانات محلياً (كنسخة احتياطية)
        function saveDataLocally() {
            try {
                localStorage.setItem('flosnaData', JSON.stringify(appData));
            } catch (error) {
                console.warn('⚠️ تحذير: فشل حفظ البيانات محلياً:', error);
            }
        }

        // تنظيف الصور من الإيداعات المقبولة/المرفوضة
        function cleanOldImages() {
            let cleaned = false;
            appData.deposits.forEach(deposit => {
                if ((deposit.status === 'approved' || deposit.status === 'rejected') && deposit.proof) {
                    delete deposit.proof;
                    cleaned = true;
                }
            });
            
            if (cleaned) {
                saveDataLocally();
                console.log('✅ تم تنظيف الصور القديمة');
            }
        }

        // دالة الحفظ القديمة (للتوافق مع الكود القديم)
        function saveData() {
            saveDataLocally();
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                    document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            document.getElementById('deposit-form').addEventListener('submit', function(e) { e.preventDefault(); addDeposit(); });
            document.getElementById('deposit-proof').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('proof-preview').src = event.target.result;
                        document.getElementById('proof-preview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('admin-login-form').addEventListener('submit', function(e) { e.preventDefault(); adminLogin(); });
            document.getElementById('expense-form').addEventListener('submit', function(e) { e.preventDefault(); addExpense(); });
            document.getElementById('withdrawal-form').addEventListener('submit', function(e) { e.preventDefault(); addWithdrawal(); });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // تحميل إعدادات الدفع عند فتح صفحة الإدارة
            if (pageId === 'admin') {
                setTimeout(() => loadPaymentSettings(), 100);
            }
            
            AOS.refresh();
        }

        // دالة لضغط الصور
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedData = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedData);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function addDeposit() {
            const name = document.getElementById('depositor-name').value;
            const phone = document.getElementById('depositor-phone').value;
            const amount = parseInt(document.getElementById('deposit-amount').value);
            const proofInput = document.getElementById('deposit-proof');
            
            if (!name || !phone || !amount || !proofInput.files[0]) { 
                showToast('يرجى ملء جميع الحقول', 'warning'); 
                return; 
            }
            
            // التحقق من وجود طريقة دفع مفعلة
            const hasPaymentMethod = (
                (appData.paymentMethods?.instapay?.enabled && appData.paymentMethods.instapay.number) ||
                (appData.paymentMethods?.ewallet?.enabled && appData.paymentMethods.ewallet.number) ||
                (appData.paymentMethods?.bank?.enabled && appData.paymentMethods.bank.account)
            );
            
            if (!hasPaymentMethod) {
                showToast('لا توجد طرق دفع متاحة حالياً. يرجى التواصل مع الإدارة', 'error');
                return;
            }
            
            // Validate Egyptian phone number (11 digits)
            if (!/^\d{11}$/.test(phone)) { 
                showToast('رقم الهاتف يجب أن يكون 11 رقم مصري', 'warning'); 
                return; 
            }

            const proofFile = proofInput.files[0];
            
            try {
                // ضغط الصورة قبل الحفظ
                const compressedImage = await compressImage(proofFile, 600, 0.6);
                
                const newDeposit = {
                    id: Date.now(), 
                    name: name, 
                    phone: phone, 
                    amount: amount,
                    date: new Date().toLocaleDateString('ar-EG'),
                    status: 'pending', 
                    proof: compressedImage
                };
                
                // إرسال إلى Google Sheets (بدون الصورة - الصورة كبيرة جداً للـ URL)
                const result = await sendToGoogleSheets('addDeposit', {
                    ID: newDeposit.id,
                    الاسم: name,
                    الهاتف: phone,
                    المبلغ: amount,
                    التاريخ: newDeposit.date,
                    الحالة: 'معلق',
                    الصورة: '' // الصورة محفوظة في LocalStorage فقط
                });
                
                if (result && result.status === 'success') {
                    // إضافة للبيانات المحلية
                    appData.deposits.push(newDeposit);
                    saveDataLocally();
                    
                    updateUI();
                    document.getElementById('deposit-form').reset();
                    document.getElementById('proof-preview').style.display = 'none';
                    
                    // استدعاء addActivity بشكل آمن
                    if (typeof addActivity === 'function') {
                        addActivity('deposit', `تم إضافة إيداع جديد من ${name}`);
                    }
                    
                    // إرسال إشعار للأدمن في الخلفية
                    notifyAdmin('deposit', {
                        name: name,
                        phone: phone,
                        amount: amount,
                        date: newDeposit.date
                    });
                    
                    // عرض رسالة نجاح مميزة
                    showSuccessModal(
                        'تم تقديم طلب الإيداع بنجاح! 🎉',
                        'تم إرسال طلبك بنجاح وسيتم مراجعته من قبل الإدارة. سيتم إشعارك فور الموافقة عليه.',
                        '💰'
                    );
                    
                    showPage('home');
                } else {
                    showToast('فشل إضافة الإيداع، حاول مرة أخرى', 'error');
                }
            } catch (error) {
                console.error('خطأ في إضافة الإيداع:', error);
                showToast('حدث خطأ في معالجة الإيداع', 'error');
            }
        }

        async function addWithdrawal() {
            const name = document.getElementById('withdrawal-name').value;
            const phone = document.getElementById('withdrawal-phone').value;
            const amount = parseInt(document.getElementById('withdrawal-amount').value);
            const reason = document.getElementById('withdrawal-reason').value;
            
            if (!name || !phone || !amount) { showToast('يرجى ملء جميع الحقول المطلوبة', 'warning'); return; }
            
            // Validate Egyptian phone number (11 digits)
            if (!/^\d{11}$/.test(phone)) { showToast('رقم الهاتف يجب أن يكون 11 رقم مصري', 'warning'); return; }

            const newWithdrawal = {
                id: Date.now(), 
                name: name, 
                phone: phone, 
                amount: amount,
                reason: reason || 'لا يوجد',
                date: new Date().toLocaleDateString('ar-EG'),
                status: 'pending'
            };
            
            // إرسال إلى Google Sheets أولاً (الترتيب: ID | الاسم | الهاتف | المبلغ | السبب | التاريخ | الحالة)
            const result = await sendToGoogleSheets('addWithdrawal', {
                ID: newWithdrawal.id,
                الاسم: name,
                الهاتف: phone,
                المبلغ: amount,
                السبب: reason || 'لا يوجد',
                التاريخ: newWithdrawal.date,
                الحالة: 'معلق'
            });
            
            if (result && result.status === 'success') {
                appData.withdrawals.push(newWithdrawal);
                saveData();
                
                updateUI();
                document.getElementById('withdrawal-form').reset();
                addActivity('withdrawal', `تم إضافة طلب سحب جديد من ${name}`);
                
                // إرسال إشعار للأدمن في الخلفية
                notifyAdmin('withdrawal', {
                    name: name,
                    phone: phone,
                    amount: amount,
                    reason: reason || 'لا يوجد',
                    date: newWithdrawal.date
                });
                
                // عرض رسالة نجاح مميزة
                showSuccessModal(
                    'تم تقديم طلب السحب بنجاح! 🎉',
                    'تم إرسال طلبك بنجاح وسيتم مراجعته من قبل الإدارة. سنتواصل معك قريباً.',
                    '💸'
                );
                
                showPage('home');
            } else {
                showToast('فشل إضافة طلب السحب، حاول مرة أخرى', 'error');
                return;
            }
        }

        function adminLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            if (username === appData.adminCredentials.username && password === appData.adminCredentials.password) {
                appData.adminLoggedIn = true;
                saveData();
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('admin-login-section').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                updateAdminDashboard();
            } else {
                showToast('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
            }
        }

        function adminLogout() {
            appData.adminLoggedIn = false;
            localStorage.setItem('adminLoggedIn', 'false');
            saveData();
            document.getElementById('admin-login-section').style.display = 'block';
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
        }

        function checkAdminLoginStatus() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (isLoggedIn) {
                appData.adminLoggedIn = true;
                document.getElementById('admin-login-section').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                updateAdminDashboard();
            }
        }

        async function addExpense() {
            console.log('🚀 بدء إضافة مصروف جديد...');
            const description = document.getElementById('expense-description').value;
            const category = document.getElementById('expense-category').value;
            const amount = parseInt(document.getElementById('expense-amount').value);
            console.log('📋 البيانات:', {description, category, amount});
            if (!description || !amount) { showToast('يرجى ملء جميع الحقول', 'warning'); return; }
            
            const newExpense = {id: Date.now(), description: description, category: category, amount: amount, date: new Date().toLocaleDateString('ar-EG')};
            
            // إرسال إلى Google Sheets أولاً (الترتيب: ID | الوصف | الفئة | المبلغ | التاريخ)
            const result = await sendToGoogleSheets('addExpense', {
                ID: newExpense.id,
                الوصف: description,
                الفئة: category,
                المبلغ: amount,
                التاريخ: newExpense.date
            });
            
            console.log('📤 نتيجة إرسال المصروف:', result);
            
            if (result && result.status === 'success') {
                appData.expenses.push(newExpense);
                saveData();
                console.log('💾 تم حفظ المصروف محلياً');
            } else {
                console.error('❌ فشل إرسال المصروف:', result);
                showToast('فشل إضافة المصروف، حاول مرة أخرى', 'error');
                return;
            }
            
            // إرسال إشعار Telegram
            console.log('📱 جاري تحضير إشعار Telegram للمصروف...');
            const message = `<b>مصروف جديد</b>\n\n<b>الوصف:</b> ${description}\n<b>الفئة:</b> ${category}\n<b>المبلغ:</b> ${amount} جنيه\n<b>التاريخ:</b> ${newExpense.date}`;
            console.log('📨 نص الرسالة:', message);
            sendTelegramNotification(message).catch(error => {
                console.error('❌ خطأ في إرسال الإشعار:', error);
            });
            
            updateUI();
            updateAdminDashboard();
            document.getElementById('expense-form').reset();
            showToast('تم إضافة المصروف بنجاح', 'success');
        }

        function updateUI() {
            updateHomePage();
            updateDepositsPage();
            if (appData.adminLoggedIn) updateAdminDashboard();
        }

        function updateHomePage() {
            const totalDeposits = appData.deposits.filter(d => d.status === 'approved').reduce((sum, deposit) => sum + deposit.amount, 0);
            const totalExpenses = appData.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalWithdrawals = appData.withdrawals.filter(w => w.status === 'approved').reduce((sum, withdrawal) => sum + withdrawal.amount, 0);
            const currentBalance = totalDeposits - totalExpenses - totalWithdrawals;
            
            document.getElementById('total-balance').innerHTML = `<i class="fas fa-pound-sign"></i> ${currentBalance}`;
            document.getElementById('total-deposits').textContent = appData.deposits.filter(d => d.status === 'approved').length;
            document.getElementById('total-expenses').textContent = appData.expenses.length;
            
            // تحديث الإحصائيات في الصفحة الرئيسية
            document.getElementById('home-total-balance').textContent = currentBalance;
            document.getElementById('home-total-deposits-amount').textContent = totalDeposits;
            document.getElementById('home-total-expenses-amount').textContent = totalExpenses;
            
            const recentDepositsContainer = document.getElementById('recent-deposits');
            const recentDeposits = appData.deposits.sort((a, b) => b.id - a.id).slice(0, 5);
            
            if (recentDeposits.length === 0) {
                recentDepositsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد إيداعات حتى الآن</p></div>';
            } else {
                let html = '';
                recentDeposits.forEach((deposit, index) => {
                    const statusIcon = deposit.status === 'approved' ? 'fa-check-circle' : deposit.status === 'rejected' ? 'fa-times-circle' : 'fa-clock';
                    html += `<div class="recent-deposit-item"><div class="deposit-name"><i class="fas fa-user-circle"></i> ${deposit.name}</div><div class="deposit-amount"><i class="fas fa-pound-sign"></i> ${deposit.amount}</div><div class="status-badge status-${deposit.status}"><i class="fas ${statusIcon}"></i>${getStatusText(deposit.status)}</div></div>`;
                });
                recentDepositsContainer.innerHTML = html;
            }
            
            // تحديث آخر السحوبات
            const recentWithdrawalsContainer = document.getElementById('recent-withdrawals');
            const recentWithdrawals = appData.withdrawals.sort((a, b) => b.id - a.id).slice(0, 5);
            
            if (recentWithdrawals.length === 0) {
                recentWithdrawalsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد سحوبات حتى الآن</p></div>';
            } else {
                let html = '';
                recentWithdrawals.forEach((withdrawal) => {
                    const statusIcon = withdrawal.status === 'approved' ? 'fa-check-circle' : withdrawal.status === 'rejected' ? 'fa-times-circle' : 'fa-clock';
                    html += `<div class="recent-deposit-item"><div class="deposit-name"><i class="fas fa-user-circle"></i> ${withdrawal.name}</div><div class="deposit-amount" style="color: var(--danger-color);"><i class="fas fa-minus"></i> ${withdrawal.amount}</div><div class="status-badge status-${withdrawal.status}"><i class="fas ${statusIcon}"></i>${getStatusText(withdrawal.status)}</div></div>`;
                });
                recentWithdrawalsContainer.innerHTML = html;
            }
        }

        function updateDepositsPage() {
            const depositsList = document.getElementById('deposits-list');
            if (appData.deposits.length === 0) {
                depositsList.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد إيداعات حتى الآن</p></div></td></tr>';
            } else {
                let html = '';
                appData.deposits.sort((a, b) => b.id - a.id).forEach(deposit => {
                    const statusIcon = deposit.status === 'approved' ? 'fa-check-circle' : deposit.status === 'rejected' ? 'fa-times-circle' : 'fa-clock';
                    const phone = deposit.phone || '-';
                    html += `<tr><td>${deposit.name}</td><td>${phone}</td><td>${deposit.amount}</td><td>${deposit.date}</td><td><span class="status-badge status-${deposit.status}"><i class="fas ${statusIcon}"></i>${getStatusText(deposit.status)}</span></td></tr>`;
                });
                depositsList.innerHTML = html;
            }
            
            const expensesList = document.getElementById('expenses-list');
            if (appData.expenses.length === 0) {
                expensesList.innerHTML = '<tr><td colspan="4"><div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد مصروفات حتى الآن</p></div></td></tr>';
            } else {
                let html = '';
                appData.expenses.sort((a, b) => b.id - a.id).forEach(expense => {
                    const category = expense.category || 'غير محدد';
                    html += `<tr><td>${expense.description}</td><td>${category}</td><td>${expense.amount}</td><td>${expense.date}</td></tr>`;
                });
                expensesList.innerHTML = html;
            }
            
            // تحديث قائمة السحوبات
            const withdrawalsList = document.getElementById('withdrawals-list');
            if (appData.withdrawals.length === 0) {
                withdrawalsList.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد سحوبات حتى الآن</p></div></td></tr>';
            } else {
                let html = '';
                appData.withdrawals.sort((a, b) => b.id - a.id).forEach(withdrawal => {
                    const statusIcon = withdrawal.status === 'approved' ? 'fa-check-circle' : withdrawal.status === 'rejected' ? 'fa-times-circle' : 'fa-clock';
                    html += `<tr><td>${withdrawal.name}</td><td>${withdrawal.phone}</td><td>${withdrawal.amount}</td><td>${withdrawal.reason}</td><td>${withdrawal.date}</td><td><span class="status-badge status-${withdrawal.status}"><i class="fas ${statusIcon}"></i>${getStatusText(withdrawal.status)}</span></td></tr>`;
                });
                withdrawalsList.innerHTML = html;
            }
        }

        function updateAdminDashboard() {
            const adminDepositsList = document.getElementById('admin-deposits-list');
            if (appData.deposits.length === 0) {
                adminDepositsList.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد إيداعات حتى الآن</p></div></td></tr>';
            } else {
                let html = '';
                appData.deposits.sort((a, b) => b.id - a.id).forEach(deposit => {
                    const statusIcon = deposit.status === 'approved' ? 'fa-check-circle' : deposit.status === 'rejected' ? 'fa-times-circle' : 'fa-clock';
                    const actionButtons = deposit.status === 'pending' ? `<button class="btn btn-primary btn-sm" onclick="updateDepositStatus(${deposit.id}, 'approved')"><i class="fas fa-check"></i> قبول</button><button class="btn btn-danger btn-sm" onclick="updateDepositStatus(${deposit.id}, 'rejected')"><i class="fas fa-times"></i> رفض</button>` : '';
                    const phone = deposit.phone || '-';
                    const proofButton = deposit.proof ? `<button class="btn btn-success btn-sm" onclick="viewProof(${appData.deposits.indexOf(deposit)})"><i class="fas fa-eye"></i> عرض الصورة</button>` : '';
                    html += `<tr data-status="${deposit.status}"><td>${deposit.name}</td><td>${phone}</td><td>${deposit.amount}</td><td>${deposit.date}</td><td><span class="status-badge status-${deposit.status}"><i class="fas ${statusIcon}"></i>${getStatusText(deposit.status)}</span></td><td class="action-buttons">${actionButtons}${proofButton}<button class="btn btn-sm" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);" onclick="deleteDeposit(${deposit.id})"><i class="fas fa-trash"></i> حذف</button></td></tr>`;
                });
                adminDepositsList.innerHTML = html;
            }
            
            const totalDeposits = appData.deposits.filter(d => d.status === 'approved').reduce((sum, deposit) => sum + deposit.amount, 0);
            const totalExpenses = appData.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalWithdrawals = appData.withdrawals.filter(w => w.status === 'approved').reduce((sum, withdrawal) => sum + withdrawal.amount, 0);
            const currentBalance = totalDeposits - totalExpenses - totalWithdrawals;
            
            document.getElementById('admin-total-deposits').textContent = totalDeposits;
            document.getElementById('admin-total-expenses').textContent = totalExpenses;
            document.getElementById('admin-current-balance').textContent = currentBalance;
            
            // تحديث قائمة السحوبات في الإدارة
            const adminWithdrawalsList = document.getElementById('admin-withdrawals-list');
            if (appData.withdrawals.length === 0) {
                adminWithdrawalsList.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد سحوبات حتى الآن</p></div></td></tr>';
            } else {
                let html = '';
                appData.withdrawals.sort((a, b) => b.id - a.id).forEach(withdrawal => {
                    const statusIcon = withdrawal.status === 'approved' ? 'fa-check-circle' : withdrawal.status === 'rejected' ? 'fa-times-circle' : 'fa-clock';
                    const actionButtons = withdrawal.status === 'pending' ? `<button class="btn btn-primary btn-sm" onclick="updateWithdrawalStatus(${withdrawal.id}, 'approved')"><i class="fas fa-check"></i> قبول</button><button class="btn btn-danger btn-sm" onclick="updateWithdrawalStatus(${withdrawal.id}, 'rejected')"><i class="fas fa-times"></i> رفض</button>` : '';
                    html += `<tr data-status="${withdrawal.status}"><td>${withdrawal.name}</td><td>${withdrawal.phone}</td><td>${withdrawal.amount}</td><td>${withdrawal.reason}</td><td>${withdrawal.date}</td><td><span class="status-badge status-${withdrawal.status}"><i class="fas ${statusIcon}"></i>${getStatusText(withdrawal.status)}</span></td><td class="action-buttons">${actionButtons}<button class="btn btn-sm" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);" onclick="deleteWithdrawal(${withdrawal.id})"><i class="fas fa-trash"></i> حذف</button></td></tr>`;
                });
                adminWithdrawalsList.innerHTML = html;
            }
            
            // تحديث قائمة المصروفات في الإدارة
            const adminExpensesList = document.getElementById('admin-expenses-list');
            if (appData.expenses.length === 0) {
                adminExpensesList.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-inbox"></i><p>لا توجد مصروفات حتى الآن</p></div></td></tr>';
            } else {
                let html = '';
                appData.expenses.sort((a, b) => b.id - a.id).forEach(expense => {
                    const category = expense.category || 'غير محدد';
                    html += `<tr><td>${expense.description}</td><td>${category}</td><td>${expense.amount}</td><td>${expense.date}</td><td class="action-buttons"><button class="btn btn-sm" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);" onclick="deleteExpense(${expense.id})"><i class="fas fa-trash"></i> حذف</button></td></tr>`;
                });
                adminExpensesList.innerHTML = html;
            }
        }

        async function updateDepositStatus(id, status) {
            const deposit = appData.deposits.find(d => d.id === id);
            if (deposit) { 
                const oldStatus = deposit.status;
                deposit.status = status;
                
                // حذف الصورة بعد القبول/الرفض لتوفير المساحة
                if (status === 'approved' || status === 'rejected') {
                    delete deposit.proof;
                }
                
                // إرسال التحديث إلى Google Sheets
                const result = await sendToGoogleSheets('updateDepositStatus', {
                    ID: id,
                    الحالة: status
                });
                
                if (result && result.status === 'success') {
                    saveDataLocally();
                    
                    // إرسال إشعار Telegram عند الموافقة فقط
                    if (status === 'approved' && oldStatus === 'pending') {
                        console.log('====== بدء محاولة إرسال Telegram للإيداع ====== ');
                        console.log('Status:', status, 'Old Status:', oldStatus);
                        console.log('Deposit:', deposit);
                        
                        const message = `<b>🎉 إيداع مؤكد ✅</b>

<b>👤 الاسم:</b> ${deposit.name}
<b>📱 الهاتف:</b> ${deposit.phone}
<b>💰 المبلغ:</b> ${deposit.amount} جنيه
<b>📅 التاريخ:</b> ${deposit.date}`;
                        
                        console.log('📤 محاولة إرسال رسالة Telegram للإيداع...');
                        console.log('Message:', message);
                        
                        try {
                            const telegramResult = await sendTelegramNotification(message);
                            console.log('🔎 نتيجة Telegram:', telegramResult);
                            if (telegramResult) {
                                alert('✅ تم إرسال إشعار Telegram بنجاح!');
                            } else {
                                alert('❌ فشل إرسال Telegram - شوف Console');
                            }
                        } catch (err) {
                            console.error('❌ خطأ في إرسال إشعار Telegram:', err);
                            alert('❌ خطأ في Telegram: ' + err.message);
                        }
                    }
                    
                    showToast('تم تحديث حالة الإيداع بنجاح', 'success');
                } else {
                    showToast('فشل تحديث الحالة', 'error');
                }
                
                updateUI(); 
                updateAdminDashboard(); 
            }
        }

        async function updateWithdrawalStatus(id, status) {
            const withdrawal = appData.withdrawals.find(w => w.id === id);
            if (withdrawal) { 
                const oldStatus = withdrawal.status;
                withdrawal.status = status;
                
                // إرسال التحديث إلى Google Sheets
                const result = await sendToGoogleSheets('updateWithdrawalStatus', {
                    ID: id,
                    الحالة: status
                });
                
                if (result && result.status === 'success') {
                    saveData();
                    
                    // إرسال إشعار Telegram عند الموافقة فقط
                    if (status === 'approved' && oldStatus === 'pending') {
                        console.log('====== بدء محاولة إرسال Telegram للسحب ====== ');
                        console.log('Status:', status, 'Old Status:', oldStatus);
                        console.log('Withdrawal:', withdrawal);
                        
                        const message = `<b>💸 سحب مؤكد ✅</b>

<b>👤 الاسم:</b> ${withdrawal.name}
<b>📱 الهاتف:</b> ${withdrawal.phone}
<b>💰 المبلغ:</b> ${withdrawal.amount} جنيه
<b>📝 السبب:</b> ${withdrawal.reason}
<b>📅 التاريخ:</b> ${withdrawal.date}`;
                        
                        console.log('📤 محاولة إرسال رسالة Telegram للسحب...');
                        console.log('Message:', message);
                        
                        try {
                            const telegramResult = await sendTelegramNotification(message);
                            console.log('🔎 نتيجة Telegram:', telegramResult);
                        } catch (err) {
                            console.error('❌ خطأ في إرسال إشعار Telegram:', err);
                        }
                    }
                    
                    showToast('تم تحديث حالة السحب بنجاح', 'success');
                } else {
                    showToast('فشل تحديث الحالة', 'error');
                }
                
                updateUI(); 
                updateAdminDashboard(); 
            }
        }

        function viewProof(index) {
            const deposit = appData.deposits[index];
            if (deposit && deposit.proof) {
                const newWindow = window.open();
                newWindow.document.write(`<html dir="rtl"><head><title>عرض الإثبات</title><style>body { margin: 0; text-align: center; background: linear-gradient(135deg, #2563eb, #7c3aed); display: flex; align-items: center; justify-content: center; min-height: 100vh; } img { max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }</style></head><body><img src="${deposit.proof}" alt="إثبات الإيداع"></body></html>`);
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'معلق';
                case 'approved': return 'مقبول';
                case 'rejected': return 'مرفوض';
                default: return status;
            }
        }

        // ========== دوال الحذف ==========
        function deleteDeposit(id) {
            if (confirm('هل أنت متأكد من حذف هذا الإيداع؟ لا يمكن التراجع عن هذا الإجراء.')) {
                const deposit = appData.deposits.find(d => d.id === id);
                if (deposit) {
                    appData.deposits = appData.deposits.filter(d => d.id !== id);
                    saveData();
                    updateUI();
                    updateAdminDashboard();
                    showToast(`تم حذف إيداع ${deposit.name} بنجاح`, 'success');
                }
            }
        }

        function deleteWithdrawal(id) {
            if (confirm('هل أنت متأكد من حذف هذا السحب؟ لا يمكن التراجع عن هذا الإجراء.')) {
                const withdrawal = appData.withdrawals.find(w => w.id === id);
                if (withdrawal) {
                    appData.withdrawals = appData.withdrawals.filter(w => w.id !== id);
                    saveData();
                    updateUI();
                    updateAdminDashboard();
                    showToast(`تم حذف سحب ${withdrawal.name} بنجاح`, 'success');
                }
            }
        }

        function deleteExpense(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف؟ لا يمكن التراجع عن هذا الإجراء.')) {
                const expense = appData.expenses.find(e => e.id === id);
                if (expense) {
                    appData.expenses = appData.expenses.filter(e => e.id !== id);
                    saveData();
                    updateUI();
                    updateAdminDashboard();
                    showToast(`تم حذف المصروف "${expense.description}" بنجاح`, 'success');
                }
            }
        }

        // ========== حذف جميع البيانات ==========
        async function deleteAllData() {
            const confirmation1 = confirm('⚠️ تحذير خطير!\n\nهل أنت متأكد 100% من حذف جميع البيانات من Google Sheets؟\n\n✅ سيتم حذف:\n- جميع الإيداعات (المعلقة، المقبولة، المرفوضة)\n- جميع المصروفات\n- جميع السحوبات (المعلقة، المقبولة، المرفوضة)\n\n❌ هذا الإجراء نهائي ولا يمكن التراجع عنه!');
            
            if (!confirmation1) {
                showToast('تم إلغاء عملية الحذف', 'info');
                return;
            }
            
            const confirmation2 = prompt('للتأكيد، اكتب كلمة "حذف" بالضبط:');
            
            if (confirmation2 !== 'حذف') {
                showToast('تم إلغاء عملية الحذف - الكلمة غير صحيحة', 'warning');
                return;
            }
            
            showLoading(true);
            
            try {
                const result = await sendToGoogleSheets('deleteAll', {});
                
                if (result && result.status === 'success') {
                    // حذف البيانات المحلية
                    appData.deposits = [];
                    appData.expenses = [];
                    appData.withdrawals = [];
                    saveDataLocally();
                    
                    updateUI();
                    updateAdminDashboard();
                    
                    showToast('✅ تم حذف جميع البيانات من Google Sheets بنجاح', 'success');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showToast('❌ فشل حذف البيانات: ' + (result?.message || 'خطأ غير معروف'), 'error');
                }
            } catch (error) {
                console.error('خطأ في حذف البيانات:', error);
                showToast('❌ حدث خطأ أثناء حذف البيانات', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== طباعة التقارير ==========
        function printBalanceReport() {
            const totalDeposits = appData.deposits.filter(d => d.status === 'approved').reduce((sum, d) => sum + d.amount, 0);
            const totalExpenses = appData.expenses.reduce((sum, e) => sum + e.amount, 0);
            const totalWithdrawals = appData.withdrawals.filter(w => w.status === 'approved').reduce((sum, w) => sum + w.amount, 0);
            const currentBalance = totalDeposits - totalExpenses - totalWithdrawals;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<!DOCTYPE html>');
            printWindow.document.write('<html dir="rtl" lang="ar">');
            printWindow.document.write('<head>');
            printWindow.document.write('<meta charset="UTF-8">');
            printWindow.document.write('<title>تقرير الرصيد الكامل - فلوسنا</title>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write('* { font-family: Cairo, sans-serif; margin: 0; padding: 0; box-sizing: border-box; }');
            printWindow.document.write('body { padding: 40px; background: #f8fafc; }');
            printWindow.document.write('.container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }');
            printWindow.document.write('.header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #3b82f6; padding-bottom: 20px; }');
            printWindow.document.write('.header h1 { color: #1e40af; font-size: 2rem; margin-bottom: 10px; }');
            printWindow.document.write('.section { margin: 30px 0; }');
            printWindow.document.write('.section-title { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; font-size: 1.2rem; }');
            printWindow.document.write('.stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }');
            printWindow.document.write('.stat-box { background: #f1f5f9; padding: 20px; border-radius: 8px; text-align: center; border-right: 4px solid; }');
            printWindow.document.write('.stat-box.balance { border-right-color: #3b82f6; }');
            printWindow.document.write('.stat-box.deposits { border-right-color: #10b981; }');
            printWindow.document.write('.stat-box.expenses { border-right-color: #ef4444; }');
            printWindow.document.write('.stat-box.withdrawals { border-right-color: #f59e0b; }');
            printWindow.document.write('.stat-label { color: #64748b; font-size: 0.9rem; margin-bottom: 8px; }');
            printWindow.document.write('.stat-value { color: #1e293b; font-size: 1.8rem; font-weight: 700; }');
            printWindow.document.write('.footer { margin-top: 40px; text-align: center; color: #94a3b8; font-size: 0.9rem; border-top: 2px solid #e2e8f0; padding-top: 20px; }');
            printWindow.document.write('@media print { body { padding: 0; background: white; } .container { box-shadow: none; } }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write('<div class="container">');
            printWindow.document.write('<div class="header">');
            printWindow.document.write('<h1>📊 تقرير الرصيد الكامل</h1>');
            printWindow.document.write('<p>فلوسنا - المحفظة الجماعية</p>');
            printWindow.document.write('<p style="margin-top: 10px; color: #3b82f6; font-weight: 600;">التاريخ: ' + new Date().toLocaleDateString('ar-EG') + '</p>');
            printWindow.document.write('</div>');
            printWindow.document.write('<div class="section">');
            printWindow.document.write('<div class="section-title">💰 ملخص الرصيد</div>');
            printWindow.document.write('<div class="stat-grid">');
            printWindow.document.write('<div class="stat-box balance"><div class="stat-label">الرصيد الحالي</div><div class="stat-value">' + currentBalance.toLocaleString('ar-EG') + ' جنيه</div></div>');
            printWindow.document.write('<div class="stat-box deposits"><div class="stat-label">إجمالي الإيداعات المقبولة</div><div class="stat-value">' + totalDeposits.toLocaleString('ar-EG') + ' جنيه</div></div>');
            printWindow.document.write('<div class="stat-box expenses"><div class="stat-label">إجمالي المصروفات</div><div class="stat-value">' + totalExpenses.toLocaleString('ar-EG') + ' جنيه</div></div>');
            printWindow.document.write('<div class="stat-box withdrawals"><div class="stat-label">إجمالي السحوبات المقبولة</div><div class="stat-value">' + totalWithdrawals.toLocaleString('ar-EG') + ' جنيه</div></div>');
            printWindow.document.write('</div></div>');
            printWindow.document.write('<div class="section"><div class="section-title">📈 تفاصيل إضافية</div>');
            printWindow.document.write('<table style="width: 100%; border-collapse: collapse;">');
            printWindow.document.write('<tr style="border-bottom: 1px solid #e2e8f0;"><td style="padding: 12px; color: #64748b;">عدد الإيداعات المقبولة</td><td style="padding: 12px; text-align: left; font-weight: 600;">' + appData.deposits.filter(d => d.status === 'approved').length + '</td></tr>');
            printWindow.document.write('<tr style="border-bottom: 1px solid #e2e8f0;"><td style="padding: 12px; color: #64748b;">عدد المصروفات</td><td style="padding: 12px; text-align: left; font-weight: 600;">' + appData.expenses.length + '</td></tr>');
            printWindow.document.write('<tr style="border-bottom: 1px solid #e2e8f0;"><td style="padding: 12px; color: #64748b;">عدد السحوبات المقبولة</td><td style="padding: 12px; text-align: left; font-weight: 600;">' + appData.withdrawals.filter(w => w.status === 'approved').length + '</td></tr>');
            printWindow.document.write('<tr><td style="padding: 12px; color: #64748b;">إجمالي العمليات</td><td style="padding: 12px; text-align: left; font-weight: 600;">' + (appData.deposits.length + appData.expenses.length + appData.withdrawals.length) + '</td></tr>');
            printWindow.document.write('</table></div>');
            printWindow.document.write('<div class="footer"><p>تم إنشاء هذا التقرير بواسطة نظام فلوسنا</p><p>© ' + new Date().getFullYear() + ' جميع الحقوق محفوظة</p></div>');
            printWindow.document.write('</div>');
            printWindow.document.write('<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }<\/script>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
        }

        function printDepositsReport() {
            const deposits = [...appData.deposits].sort((a, b) => b.id - a.id);
            const approved = deposits.filter(d => d.status === 'approved');
            const pending = deposits.filter(d => d.status === 'pending');
            const rejected = deposits.filter(d => d.status === 'rejected');
            const totalApproved = approved.reduce((sum, d) => sum + d.amount, 0);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<!DOCTYPE html><html dir="rtl" lang="ar"><head><meta charset="UTF-8">');
            printWindow.document.write('<title>تقرير الإيداعات - فلوسنا</title>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">');
            printWindow.document.write('<style>* { font-family: Cairo, sans-serif; margin: 0; padding: 0; } body { padding: 40px; background: #f8fafc; } .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; } .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #10b981; padding-bottom: 20px; } .header h1 { color: #059669; font-size: 2rem; } .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; } .summary-box { background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center; border-right: 4px solid #10b981; } .summary-box .label { color: #059669; font-size: 0.85rem; } .summary-box .value { color: #064e3b; font-size: 1.3rem; font-weight: 700; } table { width: 100%; border-collapse: collapse; } th { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px; text-align: right; } td { padding: 10px; border-bottom: 1px solid #e2e8f0; } .status { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; } .status.approved { background: #d1fae5; color: #065f46; } .status.pending { background: #fef3c7; color: #92400e; } .status.rejected { background: #fee2e2; color: #991b1b; } @media print { body { padding: 0; background: white; } }</style></head><body>');
            printWindow.document.write('<div class="container"><div class="header"><h1>📥 تقرير الإيداعات</h1>');
            printWindow.document.write('<p style="color: #059669; font-weight: 600;">التاريخ: ' + new Date().toLocaleDateString('ar-EG') + '</p></div>');
            printWindow.document.write('<div class="summary">');
            printWindow.document.write('<div class="summary-box"><div class="label">المقبولة</div><div class="value">' + approved.length + '</div></div>');
            printWindow.document.write('<div class="summary-box"><div class="label">المعلقة</div><div class="value">' + pending.length + '</div></div>');
            printWindow.document.write('<div class="summary-box"><div class="label">المرفوضة</div><div class="value">' + rejected.length + '</div></div>');
            printWindow.document.write('</div>');
            printWindow.document.write('<div style="background: #dcfce7; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;">');
            printWindow.document.write('<div style="color: #065f46;">إجمالي المبالغ المقبولة</div>');
            printWindow.document.write('<div style="color: #059669; font-size: 1.8rem; font-weight: 700; margin-top: 5px;">' + totalApproved.toLocaleString('ar-EG') + ' جنيه</div></div>');
            printWindow.document.write('<table><thead><tr><th>الاسم</th><th>الهاتف</th><th>المبلغ</th><th>التاريخ</th><th>الحالة</th></tr></thead><tbody>');
            deposits.forEach(d => {
                printWindow.document.write('<tr><td>' + d.name + '</td><td>' + (d.phone || '-') + '</td><td style="font-weight: 600;">' + d.amount.toLocaleString('ar-EG') + ' جنيه</td><td>' + d.date + '</td><td><span class="status ' + d.status + '">' + getStatusText(d.status) + '</span></td></tr>');
            });
            printWindow.document.write('</tbody></table></div>');
            printWindow.document.write('<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }<\/script></body></html>');
            printWindow.document.close();
        }

        function printExpensesWithdrawalsReport() {
            const expenses = [...appData.expenses].sort((a, b) => b.id - a.id);
            const withdrawals = [...appData.withdrawals].sort((a, b) => b.id - a.id);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            const totalWithdrawals = withdrawals.filter(w => w.status === 'approved').reduce((sum, w) => sum + w.amount, 0);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<!DOCTYPE html><html dir="rtl" lang="ar"><head><meta charset="UTF-8">');
            printWindow.document.write('<title>تقرير المصروفات والسحوبات - فلوسنا</title>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">');
            printWindow.document.write('<style>* { font-family: Cairo, sans-serif; margin: 0; padding: 0; } body { padding: 40px; background: #f8fafc; } .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; } .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #ef4444; padding-bottom: 20px; } .header h1 { color: #dc2626; font-size: 2rem; } .summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; } .summary-box { padding: 15px; border-radius: 8px; text-align: center; } .summary-box.expenses { background: #fee2e2; border-right: 4px solid #ef4444; } .summary-box.withdrawals { background: #fef3c7; border-right: 4px solid #f59e0b; } .summary-box .value { font-size: 1.5rem; font-weight: 700; } .section { margin: 30px 0; } .section-title { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; } table { width: 100%; border-collapse: collapse; } th { background: #f1f5f9; padding: 10px; text-align: right; color: #475569; } td { padding: 10px; border-bottom: 1px solid #e2e8f0; } .status { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; } .status.approved { background: #d1fae5; color: #065f46; } .status.pending { background: #fef3c7; color: #92400e; } .status.rejected { background: #fee2e2; color: #991b1b; } @media print { body { padding: 0; background: white; } }</style></head><body>');
            printWindow.document.write('<div class="container"><div class="header"><h1>📤 تقرير المصروفات والسحوبات</h1>');
            printWindow.document.write('<p style="color: #dc2626; font-weight: 600;">التاريخ: ' + new Date().toLocaleDateString('ar-EG') + '</p></div>');
            printWindow.document.write('<div class="summary">');
            printWindow.document.write('<div class="summary-box expenses"><div style="color: #991b1b;">إجمالي المصروفات</div><div class="value" style="color: #dc2626;">' + totalExpenses.toLocaleString('ar-EG') + ' جنيه</div></div>');
            printWindow.document.write('<div class="summary-box withdrawals"><div style="color: #92400e;">إجمالي السحوبات المقبولة</div><div class="value" style="color: #d97706;">' + totalWithdrawals.toLocaleString('ar-EG') + ' جنيه</div></div>');
            printWindow.document.write('</div>');
            printWindow.document.write('<div class="section"><div class="section-title">🛒 المصروفات (' + expenses.length + ')</div>');
            printWindow.document.write('<table><thead><tr><th>الوصف</th><th>الفئة</th><th>المبلغ</th><th>التاريخ</th></tr></thead><tbody>');
            if (expenses.length > 0) {
                expenses.forEach(e => {
                    printWindow.document.write('<tr><td>' + e.description + '</td><td>' + (e.category || 'غير محدد') + '</td><td style="font-weight: 600;">' + e.amount.toLocaleString('ar-EG') + ' جنيه</td><td>' + e.date + '</td></tr>');
                });
            } else {
                printWindow.document.write('<tr><td colspan="4" style="text-align: center; color: #94a3b8; padding: 20px;">لا توجد مصروفات</td></tr>');
            }
            printWindow.document.write('</tbody></table></div>');
            printWindow.document.write('<div class="section"><div class="section-title">💸 السحوبات (' + withdrawals.length + ')</div>');
            printWindow.document.write('<table><thead><tr><th>الاسم</th><th>الهاتف</th><th>المبلغ</th><th>السبب</th><th>التاريخ</th><th>الحالة</th></tr></thead><tbody>');
            if (withdrawals.length > 0) {
                withdrawals.forEach(w => {
                    printWindow.document.write('<tr><td>' + w.name + '</td><td>' + w.phone + '</td><td style="font-weight: 600;">' + w.amount.toLocaleString('ar-EG') + ' جنيه</td><td>' + w.reason + '</td><td>' + w.date + '</td><td><span class="status ' + w.status + '">' + getStatusText(w.status) + '</span></td></tr>');
                });
            } else {
                printWindow.document.write('<tr><td colspan="6" style="text-align: center; color: #94a3b8; padding: 20px;">لا توجد سحوبات</td></tr>');
            }
            printWindow.document.write('</tbody></table></div></div>');
            printWindow.document.write('<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }<\/script></body></html>');
            printWindow.document.close();
        }

        // ========== Admin Tabs ==========
        function switchAdminTab(tabName) {
            // إخفاء جميع التابات
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إزالة active من جميع الأزرار
            document.querySelectorAll('.tab-header').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار التاب المطلوب
            document.getElementById(`admin-tab-${tabName}`).classList.add('active');
            
            // تفعيل الزر المطلوب
            const activeBtn = event.target.closest('.tab-header');
            activeBtn.classList.add('active');
        }

        // ========== Admin Filters ==========
        let currentAdminDepositFilter = 'all';
        let currentAdminWithdrawalFilter = 'all';

        function filterAdminDeposits() {
            const searchTerm = document.getElementById('admin-deposits-search').value.toLowerCase();
            const rows = document.querySelectorAll('#admin-deposits-list tr');
            
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const phone = row.cells[1]?.textContent.toLowerCase() || '';
                const status = row.getAttribute('data-status') || '';
                
                const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                const matchesFilter = currentAdminDepositFilter === 'all' || status === currentAdminDepositFilter;
                
                row.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
        }

        function filterAdminDepositsByStatus(status) {
            currentAdminDepositFilter = status;
            
            // تحديث أزرار الفلتر
            document.querySelectorAll('#admin-tab-deposits .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterAdminDeposits();
        }

        function filterAdminExpenses() {
            const searchTerm = document.getElementById('admin-expenses-search').value.toLowerCase();
            const rows = document.querySelectorAll('#admin-expenses-list tr');
            
            rows.forEach(row => {
                const description = row.cells[0]?.textContent.toLowerCase() || '';
                const category = row.cells[1]?.textContent.toLowerCase() || '';
                
                const matchesSearch = description.includes(searchTerm) || category.includes(searchTerm);
                
                row.style.display = matchesSearch ? '' : 'none';
            });
        }

        function filterAdminWithdrawals() {
            const searchTerm = document.getElementById('admin-withdrawals-search').value.toLowerCase();
            const rows = document.querySelectorAll('#admin-withdrawals-list tr');
            
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const phone = row.cells[1]?.textContent.toLowerCase() || '';
                const status = row.getAttribute('data-status') || '';
                
                const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                const matchesFilter = currentAdminWithdrawalFilter === 'all' || status === currentAdminWithdrawalFilter;
                
                row.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
        }

        function filterAdminWithdrawalsByStatus(status) {
            currentAdminWithdrawalFilter = status;
            
            // تحديث أزرار الفلتر
            document.querySelectorAll('#admin-tab-withdrawals .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterAdminWithdrawals();
        }

        // ========== البحث والتصفية ==========
        let currentFilter = 'all';

        function filterDeposits() {
            const searchTerm = document.getElementById('deposits-search').value.toLowerCase();
            const rows = document.querySelectorAll('#deposits-list tr');
            
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const phone = row.cells[1]?.textContent.toLowerCase() || '';
                const status = row.getAttribute('data-status') || '';
                
                const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || status === currentFilter;
                
                row.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
        }

        function filterByStatus(status) {
            currentFilter = status;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.filter-btn').classList.add('active');
            
            filterDeposits();
        }

        // دوال التصفية للسحوبات
        let currentWithdrawalFilter = 'all';

        function filterWithdrawals() {
            const searchTerm = document.getElementById('withdrawals-search').value.toLowerCase();
            const rows = document.querySelectorAll('#withdrawals-list tr');
            
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const phone = row.cells[1]?.textContent.toLowerCase() || '';
                const status = row.getAttribute('data-status') || '';
                
                const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                const matchesFilter = currentWithdrawalFilter === 'all' || status === currentWithdrawalFilter;
                
                row.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
        }

        function filterWithdrawalsByStatus(status) {
            currentWithdrawalFilter = status;
            
            // Update active button
            const filterButtons = document.querySelectorAll('#withdrawals-list').closest('.card').querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-status') === status || btn.getAttribute('onclick')?.includes(`'${status}'`)) {
                    btn.classList.add('active');
                }
            });
            
            filterWithdrawals();
        }

        // ========== الترتيب ==========
        let sortDirection = {};

        function sortTable(tableId, colIndex) {
            const table = document.getElementById(tableId);
            const rows = Array.from(table.getElementsByTagName('tr'));
            const isAscending = sortDirection[colIndex] !== true;
            
            rows.sort((a, b) => {
                const aVal = a.cells[colIndex]?.textContent.trim() || '';
                const bVal = b.cells[colIndex]?.textContent.trim() || '';
                
                // محاولة تحويل إلى أرقام
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAscending ? aNum - bNum : bNum - aNum;
                }
                
                return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });
            
            rows.forEach(row => table.appendChild(row));
            sortDirection[colIndex] = isAscending;
        }

        // ========== التصدير ==========
        function exportDepositsToCSV() {
            let data = [];
            const filename = 'الإيداعات.csv';
            data.push('الاسم,الهاتف,المبلغ,التاريخ,الحالة');
            
            appData.deposits.forEach(deposit => {
                data.push(`"${deposit.name}","${deposit.phone}","${deposit.amount}","${deposit.date}","${getStatusText(deposit.status)}"`);
            });
            
            const csv = data.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportExpensesFromAdminToCSV() {
            let data = [];
            const filename = 'المصروفات.csv';
            data.push('الوصف,التصنيف,المبلغ,التاريخ');
            
            appData.expenses.forEach(expense => {
                data.push(`"${expense.description}","${expense.category || ''}","${expense.amount}","${expense.date}"`);
            });
            
            const csv = data.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportDepositsToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4',
                compress: true
            });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            let yPosition = 20;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            // استخدام النسخة المقلوبة من النص العربي
            const arabicText = reverseArabicText('تقرير الإيداعات');
            doc.text(arabicText, pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 15;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`التاريخ: ${new Date().toLocaleDateString('ar-EG')}`, pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 10;
            const columns = ['الاسم', 'الهاتف', 'المبلغ', 'التاريخ', 'الحالة'];
            const rows = appData.deposits.map(d => [d.name, d.phone || '-', d.amount, d.date, getStatusText(d.status)]);
            
            doc.autoTable({
                head: [columns],
                body: rows,
                startY: yPosition,
                margin: 10,
                bodyStyles: { font: 'helvetica' },
                headStyles: { font: 'helvetica' },
                didDrawPage: function(data) {
                    const str = 'صفحة ' + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
            });
            
            doc.save('الإيداعات.pdf');
        }

        function exportExpensesFromAdminToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4',
                compress: true
            });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            let yPosition = 20;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            const arabicText = reverseArabicText('تقرير المصروفات');
            doc.text(arabicText, pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 15;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`التاريخ: ${new Date().toLocaleDateString('ar-EG')}`, pageWidth / 2, yPosition, { align: 'center' });
            
            yPosition += 10;
            const columns = ['الوصف', 'التصنيف', 'المبلغ', 'التاريخ'];
            const rows = appData.expenses.map(e => [e.description, e.category || '-', e.amount, e.date]);
            
            doc.autoTable({
                head: [columns],
                body: rows,
                startY: yPosition,
                margin: 10,
                bodyStyles: { font: 'helvetica' },
                headStyles: { font: 'helvetica' },
                didDrawPage: function(data) {
                    const str = 'صفحة ' + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
            });
            
            doc.save('المصروفات.pdf');
        }

        // ========== إعادة تحديث البيانات مع البحث ==========
        const originalUpdateDepositsPage = updateDepositsPage;
        const customUpdateDepositsPage = function() {
            originalUpdateDepositsPage.call(this);
            
            // إضافة data-status لكل صف
            document.querySelectorAll('#deposits-list tr').forEach(row => {
                const statusCell = row.cells[4];
                if (statusCell) {
                    const status = statusCell.textContent.includes('معلق') ? 'pending' : 
                                 statusCell.textContent.includes('مقبول') ? 'approved' : 
                                 statusCell.textContent.includes('مرفوض') ? 'rejected' : 'unknown';
                    row.setAttribute('data-status', status);
                }
            });
            
            filterDeposits();
        };
        updateDepositsPage = customUpdateDepositsPage;

        // ========== سجل الأنشطة ==========
        let activityLog = [];

        function addActivity(action, details) {
            const timestamp = new Date().toLocaleString('ar-EG');
            activityLog.unshift({
                action: action,
                details: details,
                timestamp: timestamp,
                icon: getActivityIcon(action)
            });
            // الاحتفاظ بـ آخر 50 نشاط فقط
            if (activityLog.length > 50) activityLog.pop();
            saveActivity();
        }

        function getActivityIcon(action) {
            const icons = {
                'deposit': 'fas fa-arrow-down',
                'expense': 'fas fa-arrow-up',
                'approve': 'fas fa-check',
                'reject': 'fas fa-times',
                'login': 'fas fa-sign-in-alt'
            };
            return icons[action] || 'fas fa-info-circle';
        }

        function saveActivity() {
            localStorage.setItem('flosnaActivity', JSON.stringify(activityLog));
        }

        function loadActivity() {
            const saved = localStorage.getItem('flosnaActivity');
            if (saved) activityLog = JSON.parse(saved);
        }

        function showActivityLog() {
            const logContainer = document.getElementById('activityLog');
            if (activityLog.length === 0) {
                logContainer.innerHTML = '<p style="text-align: center; color: var(--gray-color);">لا توجد أنشطة حتى الآن</p>';
            } else {
                logContainer.innerHTML = activityLog.map(item => `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="${item.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${item.action}</div>
                            <div>${item.details}</div>
                            <div class="activity-time">${item.timestamp}</div>
                        </div>
                    </div>
                `).join('');
            }
            document.getElementById('activityModal').classList.add('active');
        }

        function closeActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
        }

        // ========== ملاحظات الإيداعات ==========
        let currentDepositId = null;

        function openNotesModal(depositId) {
            currentDepositId = depositId;
            const deposit = appData.deposits.find(d => d.id === depositId);
            document.getElementById('depositNotesInput').value = deposit?.notes || '';
            document.getElementById('notesModal').classList.add('active');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('active');
        }

        function saveDepositNotes() {
            if (currentDepositId) {
                const deposit = appData.deposits.find(d => d.id === currentDepositId);
                if (deposit) {
                    deposit.notes = document.getElementById('depositNotesInput').value;
                    saveData();
                    addActivity('note', `تم إضافة ملاحظة على إيداع ${deposit.name}`);
                    closeNotesModal();
                    showToast('تم حفظ الملاحظات بنجاح', 'success');
                }
            }
        }

        // ========== الرسوم البيانية ==========
        let depositsStatusChart = null;
        let depositsVsExpensesChart = null;

        function createCharts() {
            createDepositsStatusChart();
            createDepositsVsExpensesChart();
        }

        function createDepositsStatusChart() {
            const ctx = document.getElementById('depositsStatusChart');
            if (!ctx) return;

            const approved = appData.deposits.filter(d => d.status === 'approved').length;
            const pending = appData.deposits.filter(d => d.status === 'pending').length;
            const rejected = appData.deposits.filter(d => d.status === 'rejected').length;

            if (depositsStatusChart) depositsStatusChart.destroy();

            depositsStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['مقبول', 'معلق', 'مرفوض'],
                    datasets: [{
                        data: [approved, pending, rejected],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderColor: ['#059669', '#d97706', '#dc2626'],
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 12, family: "'Cairo', sans-serif" },
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createDepositsVsExpensesChart() {
            const ctx = document.getElementById('depositsVsExpensesChart');
            if (!ctx) return;

            const approvedDeposits = appData.deposits
                .filter(d => d.status === 'approved')
                .reduce((sum, d) => sum + d.amount, 0);
            const totalExpenses = appData.expenses.reduce((sum, e) => sum + e.amount, 0);

            if (depositsVsExpensesChart) depositsVsExpensesChart.destroy();

            depositsVsExpensesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['الإيداعات', 'المصروفات'],
                    datasets: [{
                        label: 'المبلغ',
                        data: [approvedDeposits, totalExpenses],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderColor: ['#059669', '#dc2626'],
                        borderWidth: 2,
                        borderRadius: 8,
                        hoverBackgroundColor: ['#059669', '#dc2626']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { font: { family: "'Cairo', sans-serif" } }
                        },
                        y: {
                            ticks: { font: { family: "'Cairo', sans-serif" } }
                        }
                    }
                }
            });
        }

        // تحديث الرسوم البيانية عند تحديث البيانات
        const originalUpdateHomePage = updateHomePage;
        updateHomePage = function() {
            originalUpdateHomePage.call(this);
            setTimeout(createCharts, 100);
        };

        // ========== تحديث addExpense لإضافة التصنيف ==========
        // تم دمج هذه الدالة مع الدالة الأساسية addExpense أعلاه

        // تحميل سجل الأنشطة عند بدء التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            loadActivity();
        }, { once: true });

        // إضافة أنشطة عند إجراء عمليات
        const originalUpdateDepositStatus = updateDepositStatus;
        updateDepositStatus = function(id, status) {
            const deposit = appData.deposits.find(d => d.id === id);
            if (deposit) {
                const statusText = status === 'approved' ? 'قبول' : 'رفض';
                addActivity(status === 'approved' ? 'approve' : 'reject', `تم ${statusText} إيداع ${deposit.name}`);
            }
            originalUpdateDepositStatus.call(this, id, status);
        };
    </script>

</body>
</html>
